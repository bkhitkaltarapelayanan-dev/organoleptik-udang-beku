<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Laporan Penilaian Sensori - Organoleptik udang</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
<style>
:root{--max-w:900px;font-family:'Times New Roman',Times,serif}
body{background:#f3f3f3;color:#111;padding:24px;display:flex;justify-content:center}
.container{width:100%;max-width:var(--max-w);background:white;padding:22px;border:1px solid #ddd}
h1{font-size:18px;margin:0 0 6px;text-align:center}
.kop {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding-bottom: 6px;
 margin-bottom: 25px; /* beri jarak bawah sedikit */
}

hr {
  border: 2px solid #000;
  margin: 6px 0 14px 120px; /* ⬅️ beri margin kiri agar tidak menabrak logo */
}
.kop .logo {
  position: absolute;
  left: 0;
  top: 0;
  width: 100px;
  height: 100px;
}
.kop .logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.kop-center {
  text-align: center;
  flex: 1;
  font-family: 'Times New Roman', Times, serif;
}
.kop-center .instansi {
  font-size: 18px;
  font-weight: bold;
  text-transform: uppercase;
}
.kop-center .sub {
  font-size: 13px;
}
.kop-center .small {
  font-size: 13px;
}

.form-section{margin-top:8px}
label{display:block;font-weight:600;margin-top:8px}
select, input, textarea, button{font-family:inherit}
input[type=text], input[type=date], select, textarea{width:100%;padding:6px;border:1px solid #bbb;border-radius:2px}
.row{display:flex;gap:12px}
.col{flex:1}
table{width:100%;border-collapse:collapse;margin-top:10px}
table, th, td{border:1px solid #333}
th, td{padding:6px;font-size:13px}
th{text-align:left;background:#efefef}
.small{font-size:12px;color:#444}
.actions{display:flex;gap:10px;margin-top:12px}
button{padding:8px 12px;border:0;background:#222;color:white;border-radius:4px;cursor:pointer}
button.secondary{background:#666}
#report{width:800px;padding:24px;background:white;color:#000;margin:12px auto;border:1px solid #999;display:none}
#report .report-kop{display:flex;align-items:center;justify-content:space-between}
#report .logo-sm{width:70px;height:70px;border:1px dashed #999;display:flex;align-items:center;justify-content:center;font-size:10px}
.report-kop {
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  padding-bottom: 4px;
}

.report-logo {
  position: absolute;
  left: 0;
  width: 80px;
  height: 80px;
}

.report-logo img {
  width: 80%;
  height: 80%;
  object-fit: contain;
}

.report-center {
  text-align: center;
  width: 100%;
  font-family: 'Times New Roman', Times, serif;
}

.report-center .instansi {
  font-size: 12px;
  font-weight: bold;
  text-transform: uppercase;
}

.report-center .sub {
  font-size: 8px;
  margin-top: 2px;
}

.report-center .alamat,
.report-center .kontak {
  font-size: 8px;
  margin-top: 1px;
}

.report-line {
  border: 2px solid #000;
  margin: 6px 0 12px 0;
}

#report h3{text-align:center;margin:8px 0}
#report table{width:100%;border-collapse:collapse;margin-top:10px}
#report th, #report td{border:1px solid #000;padding:6px;font-size:12px;vertical-align:middle;text-align:center}
#report td:first-child{text-align:left}
.sign{width:120px;height:auto;margin-bottom:4px}
#modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center}
#modal .box{width:90%;height:90%;background:#fff;padding:10px;display:flex;flex-direction:column}
#modal iframe{flex:1;border:1px solid #ccc}
#modal .foot{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
.spec-controls{display:flex;gap:8px;align-items:center;margin-top:6px}
.spec-list{font-size:13px;color:#333;margin-left:8px}
@media(max-width:800px){:root{--max-w:700px}.row{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
<div class="kop">
  <div class="logo">
    <img src="https://karantinaindonesia.go.id/assets/backend/images/barantSan.png" alt="Logo Instansi" style="width:150px;height:80px;object-fit:contain;">
  </div>
  <div class="kop-center">
    <div class="instansi">BADAN KARANTINA INDONESIA</div>
    <div class="sub small">LABORATORIUM KARANTINA HEWAN,IKAN DAN TUMBUHAN KALIMANTAN UTARA</div>
    <div class="small">Jl. Yos Sudarso No.11 RT.04, Kel. Lingkas Ujung, Kec. Tarakan Timur, Kota Tarakan - Kalimantan Utara 77126</div>
    <div class="small">TELEPON (0551) 21526 , 08115442414  FAKSIMILE (0551) 36508</div>
  </div>
</div>

<hr style="border:2px solid #000;margin:6px 0 14px 0;">

  <h1>Lembar Penilaian Sensori - Udang Beku</h1>

  <div class="form-section">
    <div class="row">
      <div class="col">
        <label>Nama Panelis</label>
        <select id="panelis">
          <option value="">-- Pilih Nama Panelis --</option>
          <option value="Ayu An Nisaa">Ayu An Nisaa</option>
          <option value="Nurwati">Nurwati</option>
          <option value="Etik Marlena">Etik Marlena</option>
          <option value="Anevy Zainul Isa">Anevy Zainul Isa</option>
        </select>
      </div>
      <div class="col">
        <label>Tanggal</label>
        <input type="date" id="tanggal">
      </div>
    </div>

    <label>Kode Contoh</label>
    <input type="text" id="kode" placeholder="Masukkan kode contoh...">

    <label class="small">Petunjuk: Untuk setiap subspesifikasi klik dropdown pilih nilai lalu tekan "Tambah Penilaian". Maksimum 5 penilaian per subspesifikasi.</label>

    <div id="spesifikasi-area">

      <h3>a. Lapisan Es</h3>
      <div class="spec-controls">
        <select id="lapisanesOption">
          <option value="">-- Pilih Lapisan Es --</option>
          <option value="9">9 - Rata, bening, cukup tebal pada seluruh permukaan dilapisi es.</option>
          <option value="8">8 - Rata, bening, cukup tebal, ada bagian yang terbuka 10%.</option>
          <option value="7">7 - Tidak rata, bagian yang terbuka, sebanyak 20%-30%.</option>
          <option value="6">6 - Tidak rata, bagian yang terbuka sebanyak 40%-50%. </option>
          <option value="5">5 - Banyak bagian yang terbuka 60%-70%. .</option>
          <option value="3">3 - Banyak bagian yang terbuka 80%-90%.</option>        
 	  <option value="1">1 - Tidak terdapat lapisan es pada permukaan produk </option>    
	</select>
        <button type="button" onclick="tambahPenilaian('lapisanes')">Tambah Penilaian</button>
        <div class="spec-list"><strong>Nilai:</strong> <span id="lapisanes-list">-</span> &nbsp; <strong>Rerata:</strong> <span id="lapisanes-avg">-</span></div>
      </div>

      <h3>b. Pengeringan (Dehidrasi)</h3>
      <div class="spec-controls">
        <select id="pengeringanOption">
          <option value="">-- Pilih Kondisi Pengeringan --</option>
	  <option value="9">9 - Tidak ada pengeringan pada permukaan produk.</option>
          <option value="8">8 - Sedikit mengalami pengeringan pada permukaan produk 10%.</option>
          <option value="7">7 - Pengeringan mulai jelas pada permukaan produk 20%-30%.</option>
          <option value="6">6 - Pengeringan banyak pada permukaan produk 40%-50%. </option>
          <option value="5">5 - Banyak bagian produk yang tampak mengering 60%-70%.</option>
          <option value="3">3 - Banyak bagian produk yang tampak mengering 80%-90%.</option> 
 	  <option value="1">1 - Seluruh bagian produk luar tampak mengering  </option> 
        </select>
        <button type="button" onclick="tambahPenilaian('pengeringan')">Tambah Penilaian</button>
        <div class="spec-list"><strong>Nilai:</strong> <span id="pengeringan-list">-</span> &nbsp; <strong>Rerata:</strong> <span id="pengeringan-avg">-</span></div>
      </div>

      <h3>c. Perubahan Warna</h3>
      <div class="spec-controls">
        <select id="warnaOption">
 	<option value="">-- Pilih Kondisi Perubahan Warna --</option>
	  <option value="9">9 - Belum mengalami perubahan warna pada permukaan produk.</option>
          <option value="8">8 - Sedikit mengalami perubahan warna pada permukaan produk 
10%.</option>
          <option value="7">7 - Agak banyak mengalami perubahan warna pada permukaan 
produk 20%-30%.</option>
          <option value="6">6 - Banyak mengalami perubahan warna pada permukaan produk 
40%-50%.</option>
          <option value="5">5 - Perubahan warna hampir menyeluruh pada permukaan produk 
60%-70%.</option>
          <option value="3">3 - Perubahan warna hampir menyeluruh pada permukaan produk 
80%-90%.</option> 
 	  <option value="1">1 - Perubahan warna menyeluruh pada permukaan produk.</option>
        </select>
        <button type="button" onclick="tambahPenilaian('warna')">Tambah Penilaian</button>
        <div class="spec-list"><strong>Nilai:</strong> <span id="warna-list">-</span> &nbsp; <strong>Rerata:</strong> <span id="warna-avg">-</span></div>
      </div>
    </div>

    <label>Keterangan tambahan</label>
    <textarea id="keterangan" rows="3" placeholder="Catatan lain..."></textarea>

    <div class="actions">
      <button id="previewBtn">Preview PDF</button>
      <button id="downloadBtn" class="secondary">Download PDF</button>
    </div>
  </div>
</div>

<!-- Report (PDF) -->
<div id="report">
<div class="report-kop">
  <div class="report-logo">
    <img src="signatures/barantSan.png" alt="Logo Instansi">
  </div>
  <div class="report-center">
    <div class="instansi">BADAN KARANTINA INDONESIA</div>
    <div class="sub">LABORATORIUM KARANTINA HEWAN,IKAN DAN TUMBUHAN KALIMANTAN UTARA</div>
    <div class="alamat">Jl. Yos Sudarso No.11 RT.04, Kel. Lingkas Ujung, Kec. Tarakan Timur, Kota Tarakan - Kalimantan Utara 77126</div>
    <div class="kontak">TELEPON (0551) 21526 , 08115442414  FAKSIMILE (0551) 36508</div>
  </div>
</div>
<hr class="report-line">


  <h3>Lembar Penilaian Sensori Udang Beku</h3>

  <div style="display:flex;justify-content:space-between;gap:10px;margin-top:6px">
    <div>
      <strong>Nama panelis:</strong> <span id="r-panelis"></span><br>
      <strong>Tanggal:</strong> <span id="r-tanggal"></span>
    </div>
    <div>
      <strong>Komoditas:</strong> <span id="r-kode"></span>
    </div>
  </div>

  <table style="margin-top:10px;text-align:center">
    <tbody id="r-body"></tbody>
  </table>

  <div style="margin-top:14px"><strong>Keterangan:</strong> <div id="r-keterangan" style="white-space:pre-wrap;margin-top:6px"></div></div>
  <div style="margin-top:10px"><strong>Kesimpulan:</strong> <div id="r-kesimpulan" style="white-space:pre-wrap;margin-top:6px"></div></div>

  <div style="text-align:right;margin-top:40px;">
    <div>Panelis,</div>
    <div style="height:60px" id="signature-container"></div>
    <div id="name-panelis" style="font-style:italic"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal">
  <div class="box">
    <iframe id="pdfFrame"></iframe>
    <div class="foot">
      <button id="modalClose" class="secondary">Tutup</button>
      <a id="modalDownload" href="#" download="laporan-organoleptik.pdf"><button>Download PDF</button></a>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const nilaiStore = { lapisanes: [], pengeringan: [], warna: [] };

function updateDisplay(k) {
  const l = document.getElementById(`${k}-list`);
  const a = document.getElementById(`${k}-avg`);
  const r = nilaiStore[k];
  l.innerText = r.length ? r.join(', ') : '-';
  a.innerText = r.length ? (r.reduce((a, b) => a + b, 0) / r.length).toFixed(2) : '-';
}

function tambahPenilaian(k) {
  const s = document.getElementById(k + 'Option');
  const v = parseInt(s.value);
  if (!v) { alert('Pilih nilai dahulu!'); return }
  if (nilaiStore[k].length >= 5) { alert('Maks 5 nilai.'); s.value = ''; return }
  nilaiStore[k].push(v); s.value = ''; updateDisplay(k);
}

// ✅ Otomatis load tanda tangan sesuai panelis & preload agar muncul di PDF
document.getElementById('panelis').addEventListener('change', async () => {
  const panelis = document.getElementById('panelis').value;
  const name = document.getElementById('name-panelis');
  const sig = document.getElementById('signature-container');
  name.innerText = panelis ? `(${panelis})` : '';
  sig.innerHTML = '';

  if (panelis) {
    const img = new Image();
    img.src = `signatures/${panelis}.png`;
    img.className = 'sign';
    img.crossOrigin = 'anonymous';

    // pastikan gambar selesai dimuat sebelum lanjut
    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
    });

    sig.appendChild(img);
  }
});

function collectData() {
  return {
    panelis: document.getElementById('panelis').value || '-',
    tanggal: document.getElementById('tanggal').value || '-',
    kode: document.getElementById('kode').value || '-',
    keterangan: document.getElementById('keterangan').value || '-',
    nilai: {
      lapisanes: [...nilaiStore.lapisanes],
      pengeringan: [...nilaiStore.pengeringan],
      warna: [...nilaiStore.warna]
    }
  };
}

function populateReport(data) {
  document.getElementById('r-panelis').innerText = data.panelis;
  document.getElementById('r-tanggal').innerText = data.tanggal;
  document.getElementById('r-kode').innerText = data.kode;
  document.getElementById('r-keterangan').innerText = data.keterangan;

  const tb = document.getElementById('r-body');
  tb.innerHTML = '';
  let html = `<tr><th>Spesifikasi</th><th>Sampel 1</th><th>Sampel 2</th><th>Sampel 3</th><th>Sampel 4</th><th>Sampel 5</th><th>Rata-rata</th></tr>`;
  const s = [
    { p: '1. Lapisan Es', subs: [{ l: 'Lapisan ES', k: 'lapisanes' }] },
    { p: '2. Pengeringan (Dehidrasi)', subs: [{ l: 'Pengeringan (Dehidrasi)', k: 'pengeringan' }] },
    { p: '3. Perubahan Warna', subs: [{ l: 'Perubahan Warna', k: 'warna' }] } 
  ];
  s.forEach(sec => {
    html += `<tr><td colspan="7" style="font-weight:bold;">${sec.p}</td></tr>`;
    sec.subs.forEach(sub => {
      const a = data.nilai[sub.k] || [];
      const r = a.length ? (a.reduce((x, y) => x + y, 0) / a.length).toFixed(2) : '-';
      html += `<tr><td>${sub.l}</td>`;
      for (let i = 0; i < 5; i++) { html += `<td>${a[i] !== undefined ? a[i] : '-'}</td>` }
      html += `<td>${r}</td></tr>`;
    });
  });
  tb.innerHTML = html;

  const all = [];
  Object.values(data.nilai).forEach(a => { if (a.length) { all.push(a.reduce((x, y) => x + y, 0) / a.length) } });
  const adaKurang7 = all.some(avg => avg < 7);
  const tot = all.length ? (all.reduce((x, y) => x + y, 0) / all.length).toFixed(2) : '-';
  const k = (adaKurang7)
    ? "Beberapa spesifikasi belum memenuhi standar."
    : (tot >= 7 ? "Memenuhi standar kualitas udang beku." : "Beberapa spesifikasi belum memenuhi standar.");
  document.getElementById('r-kesimpulan').innerText = k;
}

async function renderReportToPdf(preview = true) {
  const d = collectData();
  populateReport(d);

  const el = document.getElementById('report');
  el.style.display = 'block';

  // ✅ Pastikan semua gambar tanda tangan termuat sempurna sebelum capture
  const imgs = el.querySelectorAll('img');
  await Promise.all(Array.from(imgs).map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
  }));

  const canvas = await html2canvas(el, { scale: 3, useCORS: true, allowTaint: false });
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  const imgW = 210;
  const imgH = (canvas.height * imgW) / canvas.width;
  pdf.addImage(imgData, 'PNG', 0, 0, imgW, imgH);

  const blob = pdf.output('blob');
  const url = URL.createObjectURL(blob);
  el.style.display = 'none';

  if (preview) {
    document.getElementById('pdfFrame').src = url;
    document.getElementById('modalDownload').href = url;
    document.getElementById('modal').style.display = 'flex';
  } else {
    const a = document.createElement('a');
    a.href = url;
    a.download = 'laporan-organoleptik.pdf';
    a.click();
  }
}

document.getElementById('previewBtn').addEventListener('click', () => renderReportToPdf(true));
document.getElementById('downloadBtn').addEventListener('click', () => renderReportToPdf(false));
document.getElementById('modalClose').addEventListener('click', () => {
  document.getElementById('modal').style.display = 'none';
});
</script>


</body>
</html>
